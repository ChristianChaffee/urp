# «Packet was modified» — что нашёл и что сделано

## Откуда ошибка

По обсуждениям (например, [sampforum.blast.hk/showthread.php?tid=624314](https://sampforum.blast.hk/showthread.php?tid=624314), [tid=661779](https://sampforum.blast.hk/showthread.php?tid=661779)):

- Сообщение выводит **сам сервер SA-MP** при проверке входящих пакетов.
- **RakNet** считает пакет «изменённым» (bad CRC или неожиданный формат) и пишет в лог.
- После множества таких сообщений игроки могут отваливаться по таймауту.
- В одном случае проблему убрало **отключение плагина YSF** — то есть конфликт с другим плагином тоже возможен.

## Почему сырой пакет 244 не подходил

Проверка, судя по всему, выполняется **до** того, как пакет попадает в очередь и возвращается из `Receive()`. То есть:

1. Клиент шлёт пакет с ID 244.
2. RakNet/сервер проверяет пакет (CRC, список допустимых ID и т.п.).
3. Пакет считается «modified» → в лог идёт «Packet was modified».
4. Наш хук `Receive()` может этот пакет уже не увидеть или видеть после проверки — в любом случае обойти проверку перехватом только `Receive()` не удаётся.

Поэтому перехват и «съедание» пакета 244 в `Receive()` на сервере не убирало сообщение.

## Что сделано: переход на RPC 220

Чтобы не попадать под проверку сырых пакетов, сделано так:

1. **Сервер (плагин)**  
   Регистрируется обработчик **RPC с ID 220** (`CHATHIDER_RPC_KEY_PRESSED`): при вызове RPC от клиента читается один байт (код клавиши) и вызывается `OnKeyPressed(playerid, key)`.

2. **Клиент**  
   Вместо отправки сырого пакета `[244, key]` клиент вызывает **RPC 220** с одним байтом (key). RPC — штатный механизм RakNet, он не должен проходить как «modified» пакет.

В коде:

- **Сервер:** регистрация RPC в `register_rpc_key_pressed()`, обработчик `ChathiderRPCKeyPressed()` (см. `plugin.cpp`).
- **Клиент:** в `send_key_to_server()` используется слот vtable для `RPC` (сейчас `vtable[8]`) и вызов с `CHATHIDER_RPC_KEY_PRESSED`.

Если на твоей сборке клиента слот у `RPC` другой, возможны краш или отсутствие вызовов — тогда нужно подобрать правильный индекс vtable под твой бинарник.

## Полезные ссылки

- [Packet was modified, sent by id (0.3.7)](https://sampforum.blast.hk/showthread.php?tid=624314)
- [Packet was modified… Everyone times out (0.3.7-R2)](https://sampforum.blast.hk/showthread.php?tid=661779)
- [Pawn.RakNet](https://github.com/katursis/Pawn.RakNet) — перехват пакетов/RPC на стороне сервера из Pawn.
