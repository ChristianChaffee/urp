# Поиск "Packet was modified" в samp03svr

## Найдено
- **Строка** в бинарнике: `Packet was modified, sent by id: %d, ip: %s`
- **Смещение в файле:** 0x11283b
- **Виртуальный адрес (при базе 0x08048000):** 0x0815a83b

Прямых ссылок на этот адрес в коде (mov/push imm32) не найдено — адрес, скорее всего, собирается как base+offset или через GOT.

## Варианты без правки серверного бинарника

1. **Не слать кастомные пакеты/RPC с этого клиента**  
   Отключить отправку клавиш (или слать только когда нужно), чтобы не триггерить проверку.

2. **Использовать другой канал**  
   Если на сервере стоит Pawn.RakNet или аналог — зарегистрировать обработчик пакета/RPC там (со стороны Pawn).

3. **Патч бинарника (на свой риск)**  
   В дизассемблере найти функцию, которая вызывает logprintf с этой строкой (по соседству с 0x11283b или по цепочке вызовов), и:
   - либо NOP-нуть условный переход, чтобы пакет не считался «modified»;
   - либо патчить саму проверку (например, разрешить RPC 220 / packet 251).

Для патча нужен дизассемблер (IDA, Ghidra, objdump) и поиск по строке/адресу 0x0815a83b или по вызовам logprintf рядом с проверкой пакетов.

## Почему в примерах (KeyListener, chandling, SAMP-API) защиты не видно

### SAMP-API (BlastHackNet/SAMP-API)
**Клиентская** библиотека для доступа к структурам и функциям SA-MP клиента. Сама **не шлёт** кастомные пакеты на сервер — только читает CNetGame, RakClient и т.д. Сообщение «Packet was modified» от неё не появляется.

### KeyListener (CyberMor/keylistener)
- **Клиент:** шлёт сырые пакеты **244/245** через `Send(&BitStream(...), RELIABLE_ORDERED, 0)` — так же, как мы.
- **Сервер:** вешает хук только на **Receive** (через GetRakServer → патч vtable Receive). В хуке пакеты 244/245 обрабатываются и **не возвращаются** в основную логику (съедаются).
- **Почему нет «Packet was modified»:** на тех сборках сервера, под которые делался KeyListener, пакет **сначала попадает в Receive()**, потом уже разбирается основной код. Плагин забирает 244/245 в Receive и отдаёт следующий пакет — основная логика эти пакеты **вообще не видит**, поэтому и проверка по ним не срабатывает.

### chandling (dotSILENT/chandling + chandling-svr)
- **Сервер:** ставит хук на **GetPacketID**. Для пакета 251 возвращает **0xFF**, основной код считает пакет «неизвестным» и не запускает жёсткую проверку.
- **Почему нет «Packet was modified»:** на целевых сборках (0.3.7, R2–R5, 0.3DL) проверка идёт **после** вызова GetPacketID и смотрит на **возвращённый** ID. Хук подменяет 251 на 0xFF — проверка не срабатывает.

### Вывод для нашего сервера
На твоём **samp03svr** порядок другой: проверка, которая печатает «Packet was modified», выполняется **до** того, как пакет попадает в Receive() и до вызова GetPacketID. Поэтому ни хук Receive (как у KeyListener), ни хук GetPacketID (как у chandling) не помогают — пакет отсекается раньше. Скорее всего, это **другая сборка/версия** сервера (другой порядок в коде или другой слой валидации).

## Текущее состояние плагина
- GetPacketID hook установлен, но проверка «Packet was modified» выполняется **до** GetPacketID.
- Raw-пакет 251 и RPC 220 оба вызывают сообщение — оба отсекаются одной и той же проверкой на уровне сервера.
